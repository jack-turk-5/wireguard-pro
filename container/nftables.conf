#!/usr/sbin/nft -f

flush ruleset

#############################################
# 1) filter table: host INPUT + forwarding
#############################################
table inet filter {
  chain input {
    type filter hook input priority 0; policy drop;

    # ——— local & established ———
    iifname "lo" accept
    ct state established,related accept

    # ——— WireGuard handshake ———
    # listen for new handshakes on eth0:51820/udp
    iifname "eth0" udp dport 51820 accept

    # ——— UI (SSH, Proxmox, dashboard) only on wg0 or loopback ———
    iifname "wg0" tcp dport { 22, 8006, 51819 }  accept
    iifname "lo" tcp dport { 22, 8006, 51819 }  accept
  }

  chain forward {
    type filter hook forward priority 0; policy drop;

    # allow return traffic
    ct state established,related accept

    # allow client ↔ Internet / LAN
    iifname "wg0" oifname "eth0" accept
    iifname "eth0" oifname "wg0" accept
  }
}

#############################################
# 2) nat table: SNAT WireGuard clients
#############################################
table ip nat {
  chain postrouting {
    type nat hook postrouting priority 100; policy accept;

    # masquerade everything coming from wg0 out eth0
    iifname "wg0" oifname "eth0" masquerade
  }
}