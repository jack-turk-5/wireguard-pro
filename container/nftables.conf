#!/usr/sbin/nft -f
flush ruleset

table inet filter {
  chain input {
    type filter hook input priority 0; policy drop;
    iifname "lo" accept
    ct state established,related accept

    # WireGuard handshake (host eth0→container UDP/51820 via portmap)
    iifname "eth0" udp dport 51820 accept

    # UI ports only from VPN clients
    iifname "eth0" ip saddr 10.8.0.0/24 \
      tcp dport { 8006, 51819 } accept
  }

  chain forward {
    type filter hook forward priority 0; policy drop;
    ct state established,related accept

    # veth-in→eth0
    iifname "cni-wgbr0" ip saddr 10.8.0.0/24 oifname "eth0" accept

    # eth0→veth-in
    iifname "eth0" oifname "cni-wgbr0" ip daddr 10.8.0.0/24 accept
  }
}

table ip nat {
  chain postrouting {
    type nat hook postrouting priority 100; policy accept;

    # SNAT only your VPN clients on the bridge → eth0
    iifname "cni-wgbr0" ip saddr 10.8.0.0/24 oifname "eth0" masquerade
  }
}