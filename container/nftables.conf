#!/usr/sbin/nft -f

#############################################
# nftables for Proxmox & WireGuard-Pro VPN
#############################################

# 1) Flush any existing rules
flush ruleset

# 2) Filter table: INPUT + FORWARD
table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # a) Allow all on loopback (so localhost:8006 & :51819 work)
        iifname "lo" accept

        # b) Established/related traffic
        ct state established,related accept

        # c) Wake WireGuard socket (UDP 51820) on your WAN NIC
        iifname "eth0" udp dport 51820 ct state new accept

        # d) UIs only on VPN interface
        iifname "wg0" tcp dport { 22, 8006, 51819 } accept
    }

    chain forward {
        type filter hook forward priority 0; policy drop;
        ct state established,related accept
        # â†’ add any VM/container forwarding rules here
    }
}

# 3) NAT table: masquerade all VPN-client traffic out via eth0
table ip nat {
    chain postrouting {
        type nat hook postrouting priority 100; policy accept;
        oifname "eth0" masquerade
    }
}