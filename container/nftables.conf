#!/usr/sbin/nft -f

flush ruleset

#############################################
# 1) Filter table: host INPUT + forwarding
#############################################
table inet filter {
    # ——— INPUT: services on the host ———
    chain input {
        type filter hook input priority 0; policy drop;

        # a) loopback & established
        iifname "lo" accept
        ct state established,related accept

        # b) WireGuard handshake (UDP 51820)
        iifname "eth0" udp dport 51820 ct state new accept
        iifname "tap*" udp dport 51820 ct state new accept

        # c) UIs — only via VPN or localhost
        iifname "wg0" tcp dport { 22, 8006, 51819 } accept
        iifname "tap*" tcp dport { 22, 8006, 51819 } accept
        iifname "lo" tcp dport { 22, 8006, 51819 } accept
    }

    # ——— FORWARD: container/VPN routing ———
    chain forward {
        type filter hook forward priority 0; policy accept;
        ct state related,established accept

        # allow wg0 → tap* for container VPN
        iifname "wg0" oifname "tap*" accept
    }
}

#############################################
# 2) NAT table: masquerade container traffic
#############################################
table ip nat {
    chain postrouting {
        type nat hook postrouting priority 100; policy accept;
        # Masquerade all container/VPN-client traffic out via tap*
        oifname "tap*" ip daddr 192.168.0.0/24 masquerade
        oifname "eth0" masquerade
    }
}