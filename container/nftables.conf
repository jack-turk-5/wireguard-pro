#!/usr/sbin/nft -f

flush ruleset

#############################################
# 1) filter table: host INPUT + forwarding
#############################################
table inet filter {
  chain input {
    type filter hook input priority 0; policy drop;

    # a) loopback & established
    iifname "lo" accept
    ct state established,related  accept

    # b) WireGuard handshake only on wg0
    iifname "wg0" udp dport 51820 ct state new accept

    # c) UI & SSH — only via VPN or localhost
    iifname "wg0" tcp dport { 22, 8006, 51819 } accept
    iifname "lo" tcp dport { 22, 8006, 51819 } accept
  }

  chain forward {
    type filter hook forward priority 0; policy drop;
    # allow return traffic
    ct state established,related accept
    # permit wg0 → eth0 (clients → upstream)
    iifname "wg0" oifname "eth0" accept
    # permit eth0 → wg0 (upstream → clients)
    iifname "eth0" oifname "wg0" accept
  }
}

#############################################
# 2) nat table: masquerade all wg0 traffic
#############################################
table ip nat {
  chain postrouting {
    type nat hook postrouting priority 100; policy accept;
    # SNAT everything coming in on wg0 → eth0
    iifname "wg0" oifname "eth0" masquerade
  }
}